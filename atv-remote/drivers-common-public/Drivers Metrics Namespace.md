# Driver Metrics Namespace

## Specification

`drivers.<group>.<version>.<identifier>.<driverName>.<driverId>`

All drivers metrics will begin with `drivers.`

The second element will be the group of metrics being gathered:

- When the metric is specific to a driver, this will be the driver name, as defined in the `<name>` element of the `driver.xml` and retrieved dynamically with `C4:GetDriverConfigInfo ('name')`: `Pandora`
- When the metric is specific to a library/common code this will be the name of the common element: `common_url`.

The third element will be the version of the previous element:

- When the metric is specific to a driver, this is the version of the driver running, which can be retrieved with `C4:GetDriverConfigInfo ('version')`
- When the metric is specific to a library/common code, it should be retrieved from a variable stored in the library that can be updated in one place whenever the code in that library is updated.

The fourth element is an identifier element to allow for differentiating multiple uses of the same metric key in one driver (for example, common code/library used multiple ways, or multiple proxies generating the same event).  If not required, it should be set to the empty string.

The fifth element will be the driver name, as defined in the `<name>` element of the `driver.xml` and retrieved dynamically with `C4:GetDriverConfigInfo ('name')`: `Pandora`.

The sixth element will be the ID of the driver in the project, retrieved dynamically with `C4:GetDeviceID ()`.

The only allowable characters in any of the fields, or in the metric key, is the character set `-_[A-Z][a-z][0-9]`.  Any series of characters outside this range MUST be replaced with a single underscore per contiguous range of those characters.

Any data is allowed in the metric value, but it is suggested to remove any carriage returns or newlines and replace them with a string of four spaces.

It is suggested that the metric key should be in in PascalCase.  This is not a requirement, but will aid in maintaining readability and will reduce character counts compared to snake or kebab case.

If the metric is reporting an error condition, the metric key should be of the form `Error_[ErrorName]`.  This is not a requirement, but will aid in sorting and discovery of errors.

Additionally, drivers under development or metrics being prototyped should have their namespaces complete as above and then additonally be prefixed with `sandbox.`, to ensure that the metrics will work correctly and will not interfere with production metrics.

## Implementation

This spec is implemented in the `metrics.lua` module published in the `drivers-common-public` github repository.  In order for this to generate production metrics, the Lua global variable `IN_PRODUCTION` must be set to true.  This is done automatically by using `pcall (require, 'drivers-common-internal.global.production')` which requires access to the `drivers-common-internal` repository.

### Usage

Create a new metric object by using the call `Metrics:new (group, version)`. If specifying group (which must be a string), version must also be specified.  If group is not specified then the group and version will be automatically set to the result of `C4:GetDriverConfigInfo ('name')` and `C4:GetDriverConfigInfo ('version')` respectively.  The driverName and driverId will be automatically retrieved from the project.  The group, version, driverName and driverId will be made safe according to the above spec, and will be validated to make sure they are useful (i.e. not an empty string or a series of `_` characters).

When specifying a specific metric key to publish, the returned object has methods that will automatically publish the correct namespace to the matching `C4:Statsd###` calls and will also perform validation on the key (as per the namespace) and value (type checking).  All value-setting methods require a key and value, except `SetCounter` which will default the value to `1` if omitted.

### Example Usage

Common MSP metrics, generated by `msp.lua` from the `drivers-common-public` repository, assumed to be a submodule imported by this repo.

```Lua
COMMON_MSP_VER = 88

Metrics = require ('drivers-common-public.module.metrics')

MetricsMSP = Metrics:new ('dcp_msp', COMMON_MSP_VER)

MetricsMSP:SetCounter ('TRACK_PLAY_ATTEMPT')
```

```Lua
AUTH_CODE_GRANT_VER = 17

Metrics = require ('drivers-common-public.module.metrics')

local oauth = {}

function oauth:new (tParams, initialRefreshToken)
  local o = {
    NAME = tParams.NAME,
    API_CLIENT_ID = tParams.API_CLIENT_ID,
  }

  setmetatable (o, self)
  self.__index = self

  o.metrics = Metrics:new ('dcp_auth_code', AUTH_CODE_GRANT_VER, (self.NAME or self.API_CLIENT_ID))

  return o
end
```

```Lua

MetricsSXM = Metrics:new ()

local messageCode = 208

MetricsSXM:SetString ('MessageCode', tostring (messageCode))

```
